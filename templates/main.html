{% extends "layout.html" %}
{% block head %}
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.dev.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.11/handlebars.min.js"></script>
    <!-- <script type="text/javascript" src="{{url_for('static', filename='js/main.js')}}"></script> -->
    <script id="waitlist" type="text/x-handlebars-template">
    <h3>Jugadores:</h3>
    <div id="teamA">
        <h4>Equipo A:</h4>
        <ul>
        {% raw -%}
            {{#each teamAPlayers}}
                <li>{{this}}</li>
            {{/each}}
        {%- endraw %}
        </ul>
    </div>
    <div id="teamB">
        <h4>Equipo B:</h4>
        <ul>
        {% raw -%}
            {{#each teamBPlayers}}
                <li>{{this}}</li>
            {{/each}}
        {%- endraw %}
        </ul>
    </div>
   </script>
    <script id='game_full' type="text/x-handlebars-template">
        <h3>El juego está lleno</h3>
    </script>
    <script id='game' type="text/x-handlebars-template">
        <div id="turn">
        </div>
        <div id='hand'>
            <h3>Tu mano:</h3>
        </div>
        <div id='plays'>
            <h3>La mesa:</h3>
        </div>
    </script>
    <script type="text/javascript">
        const templateWait = Handlebars.compile(document.querySelector('#waitlist').innerHTML);
        const templateFull = Handlebars.compile(document.querySelector('#game_full').innerHTML);
        const templateGame = Handlebars.compile(document.querySelector('#game').innerHTML);
        var inGame = false;
        var playerData;
        var Data;
        var hand;
        var epitetos = ['compañero', 'compañera', 'campeón', 'campeona', 'máquina', 'animal', 'loco turbina', 'vieji', 'viejita', 'hermano', 'hermana']

        function choose(choices) {
          var index = Math.floor(Math.random() * choices.length);
          return choices[index];
        }


        document.addEventListener('DOMContentLoaded', () => {
            var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port)
            socket.emit('connected')
            socket.on('players_update', data => {
                Data = data;
                teamAPlayers = [data.teams.teamA.player1.username, data.teams.teamA.player2.username]
                teamBPlayers = [data.teams.teamB.player1.username, data.teams.teamB.player2.username]
                const content = templateWait({teamAPlayers, teamBPlayers})
                document.querySelector('#body').innerHTML = content
                if (inGame) {
                    const buttonOut = document.createElement("button")
                    buttonOut.innerHTML = 'Salir';
                    buttonOut.onclick = () => {
                        socket.emit('player_left', playerData )
                        inGame = false
                    };
                    document.querySelector('#teamB').appendChild(buttonOut)
                } else {
                    if (!(data.teams.teamA.full))  {
                        const buttonA = document.createElement("button")
                        buttonA.innerHTML = 'Entrar'
                        buttonA.onclick = () => {
                            socket.emit('player_enter', {team:'teamA'})
                        }
                        document.querySelector('#teamA').appendChild(buttonA)
                    };
                    if (!(data.teams.teamB.full))  {
                        const buttonB = document.createElement("button")
                        buttonB.innerHTML = 'Entrar'
                        buttonB.onclick = () => {
                            socket.emit('player_enter', {team:'teamB'})
                        }
                        document.querySelector('#teamB').appendChild(buttonB)
                    }
                }
            })

            socket.on('player_data', data =>    {
                inGame = true
                playerData = data
            })

            socket.on('game_full',() => {
                const content = templateFull()
                document.querySelector('#body').innerHTML = content
            })

            socket.on('game_starts', data =>    {
                Data = data;
                if (inGame) {
                    const content = templateGame()
                    const linebreak = document.createElement("br")
                    document.querySelector('#body').innerHTML = content
                    hand = data.teams[playerData.team][playerData.player].hand
                    const turno = document.createElement("h4")
                    if (playerData.team == data.current_player.team && playerData.player == data.current_player.player) {
                        turno.innerHTML = "Jugás vos, " + choose(epitetos)
                    } else {
                        turno.innerHTML = "Juega " + data.teams[data.current_player.team][data.current_player.player].username
                    }
                    document.querySelector('#turn').appendChild(turno)
                    for (i = 0; i<hand.length; i++ ) {
                        const button = document.createElement("button")
                        button.innerHTML = hand[i][1] + ' de ' + hand[i][2]
                        button.class = 'card'
                        button.width = '90'
                        button.onclick = (button) => {
                            if (playerData.team == data.current_player.team && playerData.player == data.current_player.player)  {
                                socket.emit('play_card', {team: playerData.team, player: playerData.player, card: hand[i]})
                                button.parentNode.removeChild(button)
                            } else {
                                const turno = document.createElement('h2')
                                turno.innerHTML = "Te dije que juega " + data.teams[data.current_player.team][data.current_player.player].username
                                document.querySelector('#turn').innerHTML = turno
                            }
                        }
                        document.querySelector('#hand').appendChild(button)
                        document.querySelector('#hand').appendChild(linebreak)
                        document.querySelector('#hand').appendChild(linebreak)
                    }
                }
            })

            socket.on('card_played', data =>    {
                const line = document.createElement("p")
                line.innerHTML = data.username + ' jugó un ' + data.card[1] + ' de ' + data.card[2]
                document.querySelector('#plays').appendChild(line)
            })
        })
    </script>
{% endblock %}
{% block cuerpo%}
    <div id='body'>
    </div>
{% endblock %}
